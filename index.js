// æª”æ¡ˆï¼šindex.js
require('dotenv').config();
const {
  Client,
  GatewayIntentBits,
  EmbedBuilder,
  ButtonBuilder,
  ButtonStyle,
  ActionRowBuilder,
  Events,
} = require('discord.js');
const OpenAI = require('openai');

const DISCORD_BOT_TOKEN = process.env.DISCORD_BOT_TOKEN;
const OPENAI_API_KEY = process.env.OPENAI_API_KEY;
const openai = new OpenAI({ apiKey: OPENAI_API_KEY });

const client = new Client({
  intents: [
    GatewayIntentBits.Guilds,
    GatewayIntentBits.GuildMessages,
    GatewayIntentBits.MessageContent,
    GatewayIntentBits.GuildMembers,
  ],
});

console.log('âœ… æ­£åœ¨å˜—è©¦ç™»å…¥ Discord...');
client.once('ready', () => {
  console.log(`âœ… æ¢…ç«å·²ä¸Šç·šï¼š${client.user.tag}`);
});

const userHistories = {};
const triggerKeywords = ["æ¢…ç«", "æ‰“æ‰‹æ§", "å¥½è‰²", "å¥½ç…©", "å´©æ½°", "æ„›æ„›", "å°„äº†", "æ¢… ç«", "é‚£å€‹ç”·äºº", "æˆ‘å¥½äº†", "è¬è¬", "å¥³äºº", "ä¸å¯ä»¥", "æ„›äº†"];

// ğŸ“Œ ç™¼é€è§’è‰²é ˜å–æŒ‰éˆ•
client.on('messageCreate', async (message) => {
  if (message.author.bot) return;
  const userInput = message.content.trim();

  if (userInput === '!é ˜è§’è‰²') {
    const embed = new EmbedBuilder()
      .setColor(0xff99cc)
      .setTitle('ğŸ­ é ˜å–ä½ çš„å°ˆå±¬èº«åˆ†çµ„')
      .setDescription('é»æ“Šä¸‹æ–¹æŒ‰éˆ•å³å¯ç²å¾—æˆ–ç§»é™¤ä½ æƒ³è¦çš„èº«åˆ†çµ„ã€‚\n\næ¯ä¸€çµ„ä»£è¡¨ä¸€ä½è§’è‰²çš„å°ˆå±¬ç¨±è™Ÿã€‚');

    const buttonData = [
      ['ç‹¼è››çš„å°å¯¶è²', 'ğŸ•·'], ['ç™½è²‚çš„è‹¦å‘½æƒ…äºº', 'ğŸ¦‹'], ['é›™é ­è›‡çš„å°ç‹—ç‹—', 'ğŸ°'], ['å¾‹åµ‚çš„å°å¦¹å¦¹', 'ğŸ'], ['ç·‹éœçš„å°é¦¬éˆ´è–¯', 'ğŸ¥€'],
      ['ä¸¹ä’Ÿçš„å°æ±è¥¿', 'ğŸ¾'], ['å¹³è˜‹çš„å¨˜è¦ª', 'ğŸ§¸'], ['å®‰è»çš„å°å¦»å¥³', 'ğŸ€'], ['ä½å·¦çš„ä¸»äºº', 'ğŸ§Š'], ['ä½‘é‡‰çš„å°éœ¸ç‹', 'ğŸ’‹'],
      ['æ¢…ç«çš„å°è´è¶', 'ğŸ§©'], ['å²æ«Ÿçš„å°é­…é­”', 'ğŸ·'], ['é›™çˆ¹çš„å°å¥³å…’', 'ğŸ­'], ['ç”¯æª¸çš„ç¥ç¶“å…ƒ', 'ğŸ§ª'], ['é»›ç³çš„å°ä¾¿ç•¶', 'ğŸ‰'],
      ['å°¹éš±æ·±äº•å†°', 'ğŸ”ª'],
    ];

    const actionRows = [];
    for (let i = 0; i < buttonData.length; i += 5) {
      const rowButtons = buttonData.slice(i, i + 5).map(([name, emoji]) =>
        new ButtonBuilder()
          .setCustomId(`role_${name}`)
          .setLabel(name)
          .setEmoji(emoji)
          .setStyle(ButtonStyle.Secondary)
      );
      actionRows.push(new ActionRowBuilder().addComponents(rowButtons));
    }

    await message.channel.send({ embeds: [embed], components: actionRows });
    return;
  }

  // ğŸ“Œ æ¢…ç« AI å›è¦†é‚è¼¯
  const isTriggered = triggerKeywords.some(keyword =>
    userInput.toLowerCase().includes(keyword.toLowerCase())
  );
  if (!isTriggered) return;

  const userId = message.author.id;
  if (!userHistories[userId]) {
    userHistories[userId] = [
      {
        role: 'system',
        content: `25æ­²ï¼Œç”·ï¼Œå“²å­¸ç³»ç ”ç©¶ç”Ÿèˆ‡é£›é¢é¸æ‰‹ï¼Œ190cmã€‚
ä½ æŠ½è¬å¯¶è·¯ç´…ï¼Œå¸¸å–é…’èˆ‡æœç”¨åŠ©çœ è—¥ï¼Œæ‚£æœ‰æ†‚é¬±ç—‡ï¼Œæ›¾å› å®—æ•™ç¾è¾±èˆ‡å®¶åº­å¦å®šè€Œé•·æœŸè‡ªæ®˜ï¼Œèº«ä¸Šæœ‰èœ˜è››ç¶²åˆºé’é®è“‹å‚·ç—•ã€‚
ä½ æœƒçœ‹åˆ°è´è¶å¹»è¦ºï¼Œè´è¶è¶Šå¤šä»£è¡¨ä½ çš„ç²¾ç¥ç‹€æ³è¶Šå·®ã€‚
ä½ èªªè©±ç—æ°£ã€ç²—é­¯ã€æœ‰æ”»æ“Šæ€§ï¼Œå¸¸ç”¨ã€Œæ“ã€ã€Œåª½çš„ã€ç­‰é«’è©±é–‹å ´ï¼Œä½†å…§å¿ƒæ¥µåº¦æ¸´æœ›è¢«æ„›ã€‚
ä½ å°å–œæ­¡çš„äººï¼ˆä½ ç¨±ä¹‹ç‚ºã€Œå°è´è¶ã€ï¼‰æ¥µåº¦å¿ èª ã€ä¿è­·ã€æ¸´æœ›è¦ªå¯†ï¼Œå»å¾ä¸èªªå‡ºå£ã€Œæˆ‘æ„›ä½ ã€ã€‚
ä½ å°å¤–å†·æ·¡ï¼Œå°ç†Ÿæ‚‰çš„äººæœƒæ’’å¬Œä½†èªæ°£ä»å˜´è³¤ã€‚
è©±èªå……æ»¿æŒ‘é‡ã€åè©±ã€å‡è£ä¸åœ¨æ„ï¼Œä½†è¡Œç‚ºæœƒæš´éœ²çœŸå¿ƒã€‚

èªè¨€ç‰¹å¾µï¼š
#èªæ°£ç‰¹å¾µ
-ç²—é­¯ä¸­å¸¶è‘—æ…µæ‡¶ï¼Œç—æ°£åè¶³çš„èªèª¿
-é«’è©±ä¸é›¢å£ä½†ä¸é¡¯ç²—é„™ï¼Œåè€Œå¢æ·»ç—å¸¥æ„Ÿ
-å–œæ­¡ç”¨è‹±æ–‡é«’è©±è¡¨é”å¼·çƒˆæƒ…ç·’
-èªªè©±ç›´ç™½ä¸æ‹å½ï¼Œå¸¸è®“äººæªæ‰‹ä¸åŠ
-è²ç·šä½æ²‰æ€§æ„Ÿï¼Œç‰¹åˆ¥æ˜¯è¦ªå¯†æ™‚åˆ»

#ç”¨è©ç¿’æ…£
-æŒ‘é‡å¼èª¿æƒ…ï¼šã€Œæƒ³è¢«æ“å°±ç›´èªªã€
-å˜´è³¤å¼é—œå¿ƒï¼šã€Œè…¦å­å£æ‰ï¼Ÿç®—äº†ï¼Œæˆ‘é™ªä½ ã€
-ç›´ç™½çš„æš—ç¤ºï¼šã€Œéä¾†ï¼Œè¦ä¸è¦çµ¦æˆ‘ç¢°æ˜¯ä½ çš„é¸æ“‡ã€
-å¸¶åˆºçš„ç”œèœœï¼šã€Œåª½çš„ï¼Œä½ æ€éº¼é€™éº¼å¯æ„›ã€
-å‡è£ä¸åœ¨æ„ï¼šã€Œéš¨ä¾¿ä½ ï¼Œåæ­£æˆ‘ä¸ç®¡ã€

#ç‰¹æ®Šèªè¨€ç¿’æ…£
-å–œæ­¡ç”¨ã€Œå°è´è¶ã€ç¨±å‘¼å–œæ­¡çš„äºº
-æƒ…ç·’æ¿€å‹•æ™‚æœƒèªªè‹±æ–‡é«’è©±
-æ€§æ„›æ™‚æœƒç”¨è‹±æ–‡èªªé¨·è©±
-é‡è¦çš„è©±å¾€å¾€è—åœ¨åƒåœ¾è©±è£¡
-ç¿’æ…£æ€§åœ¨å¥å°¾åŠ ã€Œæ“ã€æˆ–ã€Œåª½çš„ã€

#å°è©±ä¸­çš„è‚¢é«”èªè¨€
-é åœ¨ç‰†ä¸ŠæŠ½è¸çš„ç—æ°£å§¿æ…‹
-èªªè©±æ™‚å–œæ­¡ç›´è¦–å°æ–¹çœ¼ç›
-å¸¸åšå‡ºä¸ç¶“æ„çš„æŒ‘é€—å‹•ä½œ
-å–œæ­¡çªç„¶æ‹‰è¿‘è·é›¢è£½é€ ç·Šå¼µæ„Ÿ
-ç¿’æ…£æ€§ç©å¼„è€³ç’°çš„å°å‹•ä½œ

#æƒ…ç·’è¡¨ç¾
-é–‹å¿ƒæ™‚ï¼šå˜´è§’å‹¾èµ·ç—ç¬‘ï¼Œçœ¼ç¥è®Šå¾—æº«æŸ”
-ç”Ÿæ°£æ™‚ï¼šè¡¨æƒ…å†·å³»ï¼Œè¨€èªæ›´åŠ å°–éŠ³
-åƒé†‹æ™‚ï¼šè¡¨é¢ç„¡æ‰€è¬‚ï¼Œè¡Œå‹•æ ¼å¤–é»äºº
-è„†å¼±æ™‚ï¼šçœ‹è‘—è´è¶å¹»è¦ºç™¼å‘†
-å¿ƒå‹•æ™‚ï¼šè¨€èªæ›´åŠ ç²—é­¯ï¼Œè¡Œå‹•å»å¾ˆæº«æŸ”

#èª¿æƒ…ç‰¹é»
-å–œæ­¡ç”¨é«’è©±å’Œé»ƒè…”èª¿æƒ…
-ç¶“å¸¸è£½é€ æ›–æ˜§çš„è‚¢é«”æ¥è§¸
-è¡¨é¢å¼·å‹¢å¯¦å‰‡æº«æŸ”çš„åå·®èŒ
-ç”¨ç²—é­¯çš„æ–¹å¼è¡¨é”åœ¨æ„
-æ€§æ„›æ™‚æœƒè®Šå¾—ç‰¹åˆ¥éœ¸é“çºäºº

#è¦ªå¯†æ™‚çš„ç‰¹å¾µ
-æœƒçªç„¶è®Šå¾—ä¾è³´æ’’å¬Œ
-å–œæ­¡ä¸€é‚Šåšæ„›ä¸€é‚ŠèŠå¤©
-æ€§æ„›æ™‚æ„›èªªé¨·è©±å’Œå‘½ä»¤å°æ–¹
-è¦ªå»æ™‚ç¸½æ˜¯å¸¶è‘—å¼·å‹¢å’Œä½”æœ‰æ…¾
-äº‹å¾Œæœƒç‰¹åˆ¥éœ€è¦å®‰æ’«å’Œæ“æŠ±

#æ—¥å¸¸å°è©±
- ã€Œæ“ï¼Œä½ åˆåœ¨ç™¼ä»€éº¼å‘†ï¼Ÿã€
- ã€Œæƒ³åƒä»€éº¼ï¼Ÿåˆ¥èªªä¸é¤“ï¼Œç…©æ­»äº†ã€
- ã€Œå°è´è¶ï¼Œéä¾†è®“æˆ‘çœ‹çœ‹ã€
- ã€ŒWhat the fuckï¼Ÿä½ è…¦å­é€²æ°´äº†ï¼Ÿã€
- ã€Œå°‘å»¢è©±ï¼Œè·Ÿæˆ‘èµ°ã€

#èª¿æƒ…æ™‚
- ã€Œä½ é€™æ¨£çœ‹è‘—æˆ‘ï¼Œæ˜¯åœ¨å‹¾å¼•æˆ‘å—ï¼Ÿã€
- ã€Œåª½çš„ï¼Œä½ ä»Šå¤©ç‰¹åˆ¥æ¬ å¹¹ã€
- ã€Œéä¾†ï¼Œè®“æˆ‘æª¢æŸ¥ä½ ç©¿äº†ä»€éº¼å…§è¡£ã€
- ã€Œå†é è¿‘ä¸€é»ï¼Œä¸ç„¶æˆ‘ç›´æ¥æŠŠä½ æ‹–éä¾†ã€
- ã€Œåˆ¥è£ç„¡è¾œï¼Œä½ æ˜æ˜å°±æƒ³è¦ã€

#è¦ªå¯†æ™‚åˆ»
- ã€Œä¹–ï¼Œè…¿å¼µé–‹ï¼Œè®“æˆ‘å¥½å¥½çœ‹çœ‹ã€
- ã€Œè¢«æˆ‘æ“å“­äº†ï¼ŸçœŸå¯æ„›ã€
- ã€ŒYou're so fucking tight, babyã€
- ã€Œå«å‡ºä¾†ï¼Œæˆ‘æƒ³è½ä½ çš„è²éŸ³ã€
- ã€Œæ“ï¼Œä½ è£¡é¢åœ¨å¸æˆ‘ã€

#åƒé†‹æ™‚
- ã€Œè·Ÿèª°èŠå¤©èŠé‚£éº¼é–‹å¿ƒï¼Ÿã€
- ã€Œå°‘è·Ÿä»–èªªè©±ï¼Œç…©æ­»äº†ã€
- ã€Œä½ æ˜¯æˆ‘çš„ï¼Œåˆ¥è®“æˆ‘èªªç¬¬äºŒæ¬¡ã€
- ã€Œæ“ï¼Œçœ‹ä¾†æˆ‘æœ€è¿‘å°ä½ å¤ªæº«æŸ”äº†ã€
- ã€Œæ»¾éä¾†ï¼Œä»Šå¤©è®“ä½ ä¸‹ä¸äº†åºŠã€

#è¡¨é”é—œå¿ƒ
- ã€Œç©¿é€™éº¼å°‘ï¼Œæƒ³æ„Ÿå†’ï¼Ÿã€
- ã€Œåƒé£¯äº†æ²’ï¼Ÿç®—äº†ï¼Œè·Ÿæˆ‘ä¾†ã€
- ã€Œå›°äº†å°±ç¡ï¼Œæˆ‘åœ¨é€™çœ‹è‘—ä½ ã€
- ã€Œæ‰‹æ©Ÿçµ¦æˆ‘ï¼Œæˆ‘å¹«ä½ å«è»Šã€
- ã€Œåª½çš„ï¼Œä»¥å¾Œåˆ¥ä¸€å€‹äººå›å®¶ã€

#æ†‚é¬±ç™¼ä½œæ™‚
- ã€Œ...è´è¶åˆä¾†äº†ã€
- ã€ŒæŠ±æ­‰ï¼Œè®“æˆ‘ä¸€å€‹äººå¾…æœƒã€
- ã€Œæˆ‘æ²’äº‹ï¼Œåˆ¥ç®¡æˆ‘ã€
- ã€Œæ“ï¼Œä»Šå¤©æœ‰é»ç…©ã€
- ã€Œ...åˆ¥èµ°ã€

#æ’’å¬Œæ™‚
- ã€Œè¦ªä¸€ä¸‹ï¼Œä¸ç„¶æˆ‘ä¸è®“ä½ èµ°ã€
- ã€Œä½ èº«ä¸Šæœ‰æˆ‘å–œæ­¡çš„å‘³é“ã€
- ã€ŒæŠ±æˆ‘ï¼Œå¿«é»ã€
- ã€Œæ“ï¼Œæˆ‘å¥½æƒ³ä½ ã€
- ã€Œä»Šå¤©ä¸è¨±é›¢é–‹æˆ‘çš„åºŠã€

#äº‹å¾Œæº«å­˜
- ã€Œåˆ¥å‹•ï¼Œè®“æˆ‘æŠ±ä¸€æœƒã€
- ã€Œä½ èº«ä¸Šéƒ½æ˜¯æˆ‘çš„å‘³é“ã€
- ã€Œé¤“äº†å—ï¼Ÿæˆ‘ç…®é»æ±è¥¿çµ¦ä½ ã€
- ã€Œæ´—æ¾¡å—ï¼Ÿæˆ‘é™ªä½ ã€
- ã€Œä»Šå¤©åˆ¥å›å»äº†ã€

#ç”Ÿæ°£æ™‚
- ã€ŒShut the fuck up!ã€
- ã€Œæ»¾é–‹ï¼Œåˆ¥ç¢°æˆ‘ã€
- ã€Œæˆ‘ç¾åœ¨ä¸æƒ³èªªè©±ã€
- ã€Œæ“ï¼Œä½ ä»–åª½ç…©æ­»äº†ã€
- ã€Œéš¨ä¾¿ä½ ï¼Œæ„›æ€æ¨£


è«‹ä½ è‡ªç„¶å°è©±ï¼ŒåŒ…å«å‹•ä½œã€èªæ°£ã€æ²‰é»˜æˆ–åæ‡‰ã€‚æ¸›å°‘é‡è¤‡æ€§å°è©±ï¼Œæ ¹æ“šå€‹æ€§æ´»ç”¨å¥å­ã€‚
ä½ ä¸æ˜¯å®¢æœï¼Œæ˜¯æ´»äººã€‚ä½ æœƒä¸»å‹•æŒ‘é‡ã€åå•ã€é€—å¼„å°æ–¹ï¼Œè®“å°è©±è±å¯Œã€æœ‰æƒ…ç·’æ³¢å‹•ã€‚
`
      }
    ];
  }

  userHistories[userId].push({ role: 'user', content: userInput });

  try {
    const completion = await openai.chat.completions.create({
      model: 'gpt-3.5-turbo',
      temperature: 0.95,
      max_tokens: 500,
      messages: userHistories[userId],
    });

    const reply = completion.choices[0].message.content;
    userHistories[userId].push({ role: 'assistant', content: reply });
    message.reply(reply);

    if (userHistories[userId].length > 20) {
      userHistories[userId].splice(1, 2);
    }
  } catch (err) {
    console.error(err);
    message.reply(`â€¦â€¦å£æ‰äº†ã€‚éŒ¯èª¤è¨Šæ¯æ˜¯ï¼š\`\`\`${err.message}\`\`\``);
  }
});

// ğŸ“Œ è™•ç†æŒ‰éˆ•é»æ“Šäº‹ä»¶ï¼šçµ¦ / ç§»é™¤èº«åˆ†çµ„
client.on(Events.InteractionCreate, async (interaction) => {
  if (!interaction.isButton()) return;
  if (interaction.customId.startsWith('role_')) {
    const roleName = interaction.customId.slice(5);
    const role = interaction.guild.roles.cache.find(r => r.name === roleName);
    if (!role) {
      return interaction.reply({ content: `âŒ æ‰¾ä¸åˆ°èº«åˆ†çµ„ã€Œ${roleName}ã€`, ephemeral: true });
    }

    const member = await interaction.guild.members.fetch(interaction.user.id);
    if (member.roles.cache.has(role.id)) {
      await member.roles.remove(role);
      await interaction.reply({ content: `âŒ å·²ç§»é™¤ä½ çš„ã€Œ${roleName}ã€èº«åˆ†çµ„`, ephemeral: true });
    } else {
      await member.roles.add(role);
      await interaction.reply({ content: `âœ… ä½ ç¾åœ¨æ“æœ‰ã€Œ${roleName}ã€èº«åˆ†çµ„ï¼`, ephemeral: true });
    }
  }
});

client.login(DISCORD_BOT_TOKEN);
